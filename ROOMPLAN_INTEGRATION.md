# RoomPlan Native Module Integration

## Overview

This project uses a custom native RoomPlan integration instead of expo-roomplan to have full control over the implementation.

## Architecture

```
native-modules/roomplan/        ← Source of truth (version controlled)
  ├── RoomplanViewManager.swift
  ├── RoomplanViewManager.m
  └── README.md

plugins/
  └── withRoomPlan.js           ← Expo config plugin

ios/ProjectLyoko/               ← Generated (ignored by git)
  ├── RoomplanViewManager.swift  (copied from native-modules/)
  └── RoomplanViewManager.m      (copied from native-modules/)

components/
  └── RoomPlanView.tsx          ← React component
```

## How It's Hardened

### 1. Source Files Protected
- **Source location**: `native-modules/roomplan/`
- **Status**: Version controlled, safe from prebuild
- **Purpose**: Single source of truth for Swift/Objective-C code

### 2. Automatic Deployment
- **Plugin**: `plugins/withRoomPlan.js`
- **Trigger**: Runs during `npx expo prebuild`
- **Action**: Copies source files to iOS project and registers with Xcode

### 3. Git Protection
- `ios/` directory is ignored (regenerated on demand)
- `native-modules/` is tracked (permanent source)

## Rebuilding the iOS Project

When you run `npx expo prebuild --clean`:

1. ✅ `ios/` directory is deleted
2. ✅ Fresh iOS project is generated
3. ✅ Config plugin runs automatically
4. ✅ RoomPlan files are copied from `native-modules/`
5. ✅ Files are added to Xcode project

**Result**: Your custom Swift code is restored automatically!

## Making Changes

### To modify RoomPlan implementation:

1. Edit files in `native-modules/roomplan/`:
   ```bash
   # Edit the source files
   code native-modules/roomplan/RoomplanViewManager.swift
   ```

2. **Option A**: Manual copy (quick iteration)
   ```bash
   cp native-modules/roomplan/*.{swift,m} ios/ProjectLyoko/
   ```

3. **Option B**: Full rebuild (guaranteed clean state)
   ```bash
   npx expo prebuild --clean --platform ios
   cd ios && pod install
   ```

## Usage in React Native

```tsx
import RoomPlanView, { RoomPlanViewHandle } from '@/components/RoomPlanView';

const ref = useRef<RoomPlanViewHandle>(null);

<RoomPlanView
  ref={ref}
  style={{ flex: 1 }}
  onScanFinished={(e) => console.log(e.nativeEvent.roomJson)}
  onExportComplete={(e) => console.log(e.nativeEvent.usdzBase64)}
/>

// Control methods
ref.current?.startScanning();
ref.current?.stopScanning();
ref.current?.exportScanResults();
```

## What's Protected From Prebuild

✅ **Safe** (will survive prebuild):
- `native-modules/roomplan/*` - Source files
- `plugins/withRoomPlan.js` - Config plugin
- `components/RoomPlanView.tsx` - React component
- `app.json` configuration

❌ **Not safe** (regenerated by prebuild):
- `ios/ProjectLyoko/RoomplanViewManager.*` - Generated copies
- `ios/ProjectLyoko/AppDelegate.swift` - Expo-managed
- `ios/Podfile` - Expo-managed

## Verification

To verify the setup is working:

```bash
# 1. Clean rebuild
npx expo prebuild --clean --platform ios

# 2. Check files were copied
ls -la ios/ProjectLyoko/Roomplan*

# 3. Run pod install
cd ios && pod install

# 4. Build the app
npm run ios
```

## Requirements

- iOS 16.0+ (configured in `app.json`)
- LiDAR-enabled device
- Camera permissions (configured in `app.json`)

## Troubleshooting

**Files missing after prebuild?**
- Ensure `native-modules/roomplan/` contains the source files
- Check `app.json` includes `"./plugins/withRoomPlan.js"` in plugins
- Verify the plugin script has no errors

**Build errors?**
- Check `ios/ProjectLyoko/ProjectLyoko-Bridging-Header.h` has React imports
- Run `cd ios && pod install`
- Clean build folder in Xcode
